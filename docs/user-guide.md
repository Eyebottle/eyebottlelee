# 아이보틀 진료녹음 & 자동실행 매니저 사용 가이드

이 문서에서는 처음 설치부터 일상적인 진료 녹음, 프로그램 자동 실행, 문제 해결까지 전 과정을 안내합니다. Windows 데스크톱 환경을 기준으로 설명하며, WSL에서 개발하고 Windows에서 실행하는 워크플로우를 전제로 합니다.

---

## 1. 준비 사항

### 1.1 필수 설치
- Flutter 3.35.3 (Windows Desktop 지원 활성화)
- Visual Studio 2022 Community (Desktop development with C++)
- OneDrive(선택) — 파일 동기화용
- USB/유선 마이크 또는 Windows 기본 입력 장치

### 1.2 경로 구성
| 위치 | 용도 | 기본 경로 |
| --- | --- | --- |
| WSL 개발 경로 | 코드 작성 | `/home/<user>/projects/eyebottlelee` |
| Windows 실행 경로 | Flutter Windows 빌드 | `C:\ws-workspace\eyebottlelee` |

post-commit 훅이 자동으로 WSL → Windows 복사를 수행합니다. 수동으로 동기화하려면:
```bash
bash scripts/sync_wsl_to_windows.sh
```

---

## 2. 첫 실행 체크리스트
1. Windows PowerShell에서 `flutter run -d windows` 실행
2. 앱 실행 후 다음 항목을 확인합니다.
   - 마이크 권한 허용 여부 (필요시 Windows 설정 > 개인정보 > 마이크에서 활성화)
   - 기본 진료 시간표 (월~금 오전 09:00-13:00, 오후 14:00-18:00)
   - 저장 폴더 (기본은 앱 문서 폴더, OneDrive 폴더 선택 권장)
   - 자동 마이크 점검 카드가 “정상” 혹은 “주의” 메시지를 표시하는지 확인

---

## 3. 메인 화면 구조
앱은 3개의 탭으로 구성됩니다:

### 3.1 녹음 대시보드
| 영역 | 설명 |
| --- | --- |
| 녹음 상태 카드 | 현재 녹음 상태, 누적 시간, 수동 시작/중지 버튼 |
| 오늘 일정 | 오늘 예정된 진료 세션 목록 (AM/PM) |
| 마이크 점검 카드 | 최근 진단 결과, "다시 점검" 버튼 |
| 저장 경로 카드 | 현재 저장 위치 및 보관 정책 |

### 3.2 녹음 설정
녹음과 관련된 모든 설정을 관리하는 탭입니다:

| 설정 카드 | 설명 |
| --- | --- |
| 진료 시간표 설정 | 요일별 오전/오후 진료 시간 설정 (자동 녹음 스케줄) |
| 저장 폴더 선택 | 녹음 파일 저장 위치 지정 (OneDrive 동기화 권장) |
| 파일 보관 기간 | 자동 삭제 정책 설정 (영구/1주/1개월/3개월/6개월) |
| 녹음 품질 · 민감도 | 비트레이트, 샘플레이트, 조용한 환경 보정 설정 |
| 무음 감지(VAD) | 무음 구간 자동 스킵 및 민감도 조절 |

각 카드의 고급 설정 버튼(톱니바퀴 아이콘)을 통해 세부 옵션을 조정할 수 있습니다.

### 3.3 자동 실행 (● ON/OFF 표시)
자주 사용하는 프로그램들을 앱 시작 시 자동으로 실행하는 기능입니다. 탭 레이블에 현재 자동 실행 활성화 여부가 표시됩니다.

> **팁:** 메인 화면 우측 상단의 `?` 버튼에서 언제든 "도움말 & 빠른 시작"을 열 수 있습니다.

---

## 4. 녹음 흐름
1. **자동 녹음**: 진료 시간표에 따라 자동으로 시작/정지합니다.
2. **수동 제어**: 대시보드 또는 트레이 아이콘에서 “녹음 시작/중지”를 선택해 즉시 제어할 수 있습니다.
3. **세그먼트 분할**: 10분마다 자동으로 파일이 분할되며, `YYYY-MM-DD` 폴더로 정리됩니다.
4. **무음 스킵**: VAD(무음 감지)가 활성화되면 작은 소리도 놓치지 않도록 민감도가 조정됩니다.

---

## 5. 스케줄 및 보관 설정

### 5.1 진료 시간표 설정
1. 메인 화면 → **녹음 설정 탭** → "진료 시간표 설정" 카드
2. **요일별 토글**: 월~일 각 요일의 오전/오후 스위치를 켜거나 끔
3. **시간 범위 조정**:
   - 오전 구간: 기본 09:00-13:00 (슬라이더로 조정 가능)
   - 오후 구간: 기본 14:00-18:00 (슬라이더로 조정 가능)
4. 설정된 시간표에 따라 자동으로 녹음이 시작/중지됩니다.

### 5.2 저장 폴더 설정
1. "저장 폴더 선택" 카드에서 **폴더 선택** 버튼 클릭
2. Windows 폴더 선택 다이얼로그에서 원하는 위치 지정
3. **OneDrive 폴더 권장**: 자동 클라우드 백업 및 동기화
4. 현재 저장 경로가 카드에 표시됨

### 5.3 보관 기간 설정
1. "파일 보관 기간" 카드에서 고급 설정(톱니바퀴 아이콘) 클릭
2. 드롭다운에서 보관 기간 선택:
   - 영구 보관 (삭제하지 않음)
   - 1주일 후 삭제
   - 1개월 후 삭제
   - 3개월 후 삭제
   - 6개월 후 삭제
3. 설정된 기간이 지나면 자동으로 파일 삭제 및 빈 폴더 정리

### 5.4 고급 설정 (품질 및 VAD)
각 카드의 고급 설정 버튼을 통해 다음 항목을 관리합니다:

- **녹음 품질 · 민감도**:
  - 품질 프로필: 64kbps (높음) / 48kbps (중간) / 32kbps (낮음)
  - 조용한 환경 보정: 0~+12dB (마이크 게인 보정)

- **VAD 민감도**:
  - 기본값: 0.006
  - 조용한 진료실: 0.004 권장
  - 시끄러운 환경: 0.008 권장

변경 사항은 즉시 저장되며 SharedPreferences에 기록됩니다.

---

## 6. 시스템 트레이 사용법
- 창 닫기 혹은 `Alt+F4` → 앱은 종료되지 않고 트레이로 숨습니다.
- 트레이 아이콘 좌/더블 클릭 → 메인 창 다시 열기
- 우클릭 메뉴 항목:
  - **녹음 시작/중지** (현재 상태에 따라 토글)
  - **마이크 점검** (3초 샘플로 진단)
  - **설정 열기** (메인 창 포커스)
  - **종료** (녹음을 안전하게 중단하고 앱 종료)
- 아이콘 색상: 녹음(빨강), 대기(초록), 오류(노랑)

---

## 7. 자동 실행 매니저

앱 시작 시 자주 사용하는 프로그램들(EMR, 문서 편집기, 브라우저 등)을 순차적으로 자동 실행할 수 있습니다.

### 7.1 기본 사용법
1. 메인 화면 → **자동 실행 탭** 선택
2. 상단의 "자동 실행" 스위치를 켜서 기능 활성화
3. "프로그램 추가" 버튼을 눌러 프로그램 추가 다이얼로그 열기
   - **파일 선택**: "찾아보기" 버튼으로 실행할 파일 선택 (실행 파일, 문서, URL 등)
   - **프로그램명**: 식별하기 쉬운 이름 입력 (예: "EMR 시스템")
   - **대기 시간**: 이전 프로그램 실행 후 대기할 시간(초) 설정 (기본 3초)
   - "추가" 버튼으로 목록에 등록
4. 추가된 프로그램들의 **드래그 핸들(⋮⋮)**을 잡고 드래그하여 실행 순서 조정
5. 각 프로그램 우측의 **스위치**로 개별 활성화/비활성화
6. **편집 버튼(연필 아이콘)**으로 프로그램 정보 수정, **삭제 버튼(휴지통 아이콘)**으로 제거
7. "테스트 실행" 버튼으로 설정 확인

### 7.2 설정 항목
| 항목 | 설명 |
| --- | --- |
| 프로그램명 | 식별하기 쉬운 이름 (예: "EMR 시스템", "원무 문서") |
| 실행 경로 | 프로그램 파일 또는 문서의 전체 경로 |
| 대기 시간 | 이전 프로그램 실행 후 다음 프로그램까지의 대기 초 (기본 3초) |
| 활성화 | 개별 프로그램의 실행 여부 토글 |

### 7.3 실행 흐름
1. 앱 시작 시 "자동 실행" 스위치가 ON이면 자동으로 시작
2. 목록 순서대로 각 프로그램을 실행
3. 각 프로그램 실행 후 설정된 대기 시간만큼 지연
4. 모든 프로그램 실행 완료 시 알림 표시
5. 실행 중 오류 발생 시 해당 프로그램 건너뛰고 계속 진행

### 7.4 권장 사용 예시
```
1. 원무 EMR (C:\Program Files\Hospital\EMR.exe) - 대기 5초
2. 진료 일정 (C:\Users\...\Documents\schedule.xlsx) - 대기 3초
3. 병원 포털 (https://hospital.example.com) - 대기 2초
```

### 7.5 실행 상태 표시
- **실행 전**: 모든 버튼 활성화, 프로그램 목록 편집 가능
- **실행 중**:
  - "테스트 실행" 버튼이 "실행 중..." 텍스트와 로딩 표시로 변경
  - 모든 편집 버튼 비활성화 (추가, 편집, 삭제, 스위치, 드래그)
  - 진행 상태 스낵바로 현재 실행 중인 프로그램 표시
- **완료/실패**: 결과 메시지 표시 후 버튼 다시 활성화

### 7.6 주의사항
- 파일 경로가 유효하지 않으면 프로그램 타일에 **빨간색 경고 아이콘**과 "파일을 찾을 수 없습니다" 메시지 표시
- 실행 중에는 설정 변경 불가 (모든 버튼 비활성화)
- 설정은 JSON 파일로 저장되어 앱 재시작 시에도 유지
- Windows의 기본 프로그램 연결 설정을 따름 (문서는 관련 앱으로 열림)

### 7.7 문제 해결
- **프로그램이 실행되지 않음**: 파일 경로 확인, 권한 문제 검토
- **너무 빠르게 실행됨**: 대기 시간을 늘려 프로그램 로딩 시간 확보
- **특정 프로그램에서 멈춤**: 해당 프로그램을 비활성화하거나 제거 후 테스트

---

## 8. 자동 마이크 점검

### 8.1 점검 방식
앱은 두 가지 방식으로 마이크 입력 레벨을 점검합니다:

- **자동 점검**: 앱 시작 시 자동으로 3초 샘플을 녹음하여 마이크 상태를 진단합니다.
- **수동 점검**: 대시보드의 "다시 점검" 버튼이나 트레이 메뉴의 "마이크 점검"을 통해 언제든 재진단할 수 있습니다.

### 8.2 진단 기준
점검 결과는 **RMS (Root Mean Square)** 값을 기반으로 판정됩니다:
- **정상 기준**: RMS 0.04 이상
- RMS는 신호의 평균 전력을 나타내며, 0.04 이상이면 진료실 대화를 녹음하기에 충분한 입력 레벨입니다.

### 8.3 상태별 해석
| 상태 | 평균 레벨(dBFS) | SNR(dB) | 설명 | 권장 조치 |
| --- | --- | --- | --- | --- |
| 정상 | ≥ -24 또는 -33 이상 & SNR ≥ 6 | ≥ 6 | 입력 레벨이 충분합니다. (RMS ≥ 0.04) | 추가 조치 없음 |
| 낮음 | -33 ~ -24 | 3~6 | 약간 낮은 수준입니다. | 마이크 위치 조정, Windows 입력 볼륨 ↑ |
| 매우 낮음 | < -33 | < 3 | 소리가 거의 들어오지 않습니다. | 케이블/음소거 확인, 장치 재선택 |
| 권한/장치 오류 | - | - | 권한 거부 또는 장치 미검출 | Windows 설정에서 권한/기본 장치 확인 |

### 8.4 사용 시나리오
- **초기 설정**: 앱 설치 후 첫 실행 시 자동 점검으로 마이크 상태 확인
- **환경 변경**: 마이크 교체, 위치 변경, PC 재부팅 후 "다시 점검"으로 재확인
- **문제 발생**: 녹음이 너무 작거나 들리지 않을 때 점검하여 원인 파악
- **일상 점검**: 진료 시작 전 트레이 메뉴에서 빠르게 점검

**도움말 버튼**을 눌러 민감도 조정 가이드를 확인할 수 있습니다.

---

## 9. 저장 및 동기화
1. 기본 저장 경로는 앱 문서 디렉터리입니다.
2. **저장 폴더 선택**에서 OneDrive 폴더를 지정하면 자동으로 클라우드에 동기화됩니다.
3. 보관 기간을 설정하면 지정된 기간 이후 파일이 자동 삭제되며 빈 날짜 폴더도 정리됩니다.

> **주의:** OneDrive가 동기화 중일 때는 삭제된 파일이 휴지통으로 이동할 수 있으므로, 장기 보관은 OneDrive 정책을 확인하세요.

---

## 10. 문제 해결 & FAQ

### 녹음 관련
- **녹음 시작 실패**: 마이크 권한, 장치 연결 상태, 다른 앱의 점유 여부 확인
- **트레이 아이콘 미표시**: `scripts/windows/generate-placeholder-icons.ps1`로 아이콘 생성 후 앱 재실행
- **스케줄이 적용되지 않음**: SharedPreferences 초기화 필요 시 설정 저장 후 앱을 재시작하세요.

### 자동 실행 관련
- **자동 실행이 작동하지 않음**:
  - 자동 실행 탭에서 스위치가 ON인지 확인
  - 등록된 프로그램이 활성화 상태인지 확인
  - 파일 경로가 유효한지 확인 (빨간색 경고 확인)
- **특정 프로그램만 실행되지 않음**:
  - 파일이 실제로 존재하는지 확인
  - Windows의 기본 앱 연결 설정 확인
  - 해당 프로그램을 비활성화하고 다른 프로그램들만 테스트
- **실행 순서 문제**: 대기 시간을 늘려 이전 프로그램의 로딩 완료 대기
- **설정이 저장되지 않음**: 앱을 관리자 권한으로 실행하거나 문서 폴더 권한 확인

추가 질문은 `docs/developing.md`의 문제 해결 섹션 또는 팀 Slack 채널을 참고하세요.

---

## 11. 추가 리소스
- 개발 가이드: [docs/developing.md](./developing.md)
- 제품 요구사항(PRD): [docs/medical-recording-prd.md](./medical-recording-prd.md)
- 동기화 워크플로우: [docs/sync-workflow.md](./sync-workflow.md)
- 아이콘 생성 스크립트: `scripts/windows/generate-placeholder-icons.ps1`
- 설치 가이드: [INSTALL.md](../INSTALL.md)

---

## 12. 앱 내 도움말/튜토리얼
- 메인 화면 우측 상단 `도움말` 버튼 → "도움말 & 빠른 시작" 다이얼로그 열기
- 다이얼로그의 `대시보드 튜토리얼` 버튼 → 녹음 상태 카드, 마이크 진단, 일정 요약, 트레이 안내를 순차적으로 하이라이트
- `설정 튜토리얼` 버튼 → 시간표, 저장 위치, 보관 기간, 녹음 품질·민감도, VAD 항목을 차례로 안내
- `자동 실행 튜토리얼` 버튼 → 자동 실행 스위치, 프로그램 추가 버튼, 테스트 실행 버튼을 순서대로 안내
- 시스템 트레이 메뉴의 `도움말` 항목에서도 동일하게 호출 가능하며, 튜토리얼은 언제든지 반복 실행할 수 있습니다.
- 상세 설명은 GitHub의 최신 사용자 가이드와 연동됩니다.

즐거운 진료 녹음 작업을 위해 주기적으로 마이크 입력을 점검하고, 스케줄/보관 정책을 최신 상태로 유지하세요!

---

## 13. 테스트앱 설치 & 진료실 검증
1. **패키지 수령**: 개발 PC에서 `flutter build windows --release` 후 생성된 `build\windows\x64\runner\Release` 폴더를 ZIP으로 묶어 진료실 PC로 전달합니다. MSIX가 필요한 경우 `dart run msix:create` 결과를 함께 제공합니다.
2. **검증 전 준비**: 진료실 PC에 마이크와 스피커를 연결하고, Windows 사운드 설정에서 기본 입력 장치를 확인합니다. OneDrive를 사용한다면 동기화가 완료됐는지 상태 아이콘을 확인합니다.
3. **설치 및 실행**: ZIP을 원하는 위치에 풀고 `아이보틀 진료녹음 & 자동실행 매니저.exe`를 실행합니다. 첫 실행 시 마이크 권한 요청이 뜨면 허용합니다.
4. **초기 체크리스트**:
   - 마이크 점검 카드가 "정상" 또는 "주의" 상태로 표시되는지 확인
   - 고급 설정에서 테스트에 사용할 녹음 품질·민감도 프리셋을 선택
   - 저장 폴더를 테스트용 OneDrive 경로 또는 로컬 전용 폴더로 지정
   - **자동 실행 탭**에서 자주 사용하는 프로그램 등록 및 테스트 (선택 사항)
5. **3단계 사용성 테스트**:
   - **준비 레코딩**: 트레이 메뉴의 "마이크 점검"으로 3초 샘플을 재검사하고, 진료실 배경 소리에서도 "정상" 판정이 나오는지 확인합니다.
   - **시나리오 녹음**: 모의 진료를 15분 이상 진행하며 작은 목소리·속삭임·기기 소음 등 다양한 입력을 테스트합니다. 세그먼트가 10분 단위로 분리되고 파일명이 날짜별 폴더에 정리되는지 확인합니다.
   - **종료·리뷰**: 녹음을 종료하고 저장 폴더에서 파일 크기와 메타 로그(`EyebottleRecorder/logs`)를 확인한 뒤, 필요한 경우 메이크업 게인이나 VAD 임계값을 조정합니다.
6. **자동 실행 검증 (선택)**:
   - 자주 사용하는 EMR이나 문서 프로그램 2-3개를 자동 실행 탭에 등록
   - "테스트 실행" 버튼으로 순차 실행 확인
   - 앱을 재시작하여 자동 실행이 정상 작동하는지 검증
7. **Soak 테스트(선택)**: 장시간 안정성을 검증하려면 PowerShell에서 `pwsh -File scripts\windows\run-soak-test.ps1`를 실행해 8시간 테스트를 진행하고, 생성된 `metrics.csv`와 로그를 검토합니다.
8. **피드백 기록**: 문제나 개선점은 `docs/developing.md` 체크리스트와 비교해 기록하고, 팀 공유 채널에 로그·스크린샷을 첨부합니다.

