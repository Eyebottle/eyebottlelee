# WAV → AAC/Opus 변환 기능 최종 진단 및 계획서

**작성일**: 2025-10-30  
**프로젝트**: 아이보틀 진료 녹음 (Eyebottle Medical Recorder)  
**현재 버전**: v1.2.10+10  
**대상 기능**: WAV 파일 사후 변환 (v1.3.0 예정)

---

## 📊 현재 상황 진단

### 1. 핵심 문제: 진료실 PC에서 WAV 외 녹음 불가

**증상**:
- 개발 PC: AAC 정상 작동 ✅
- 진료실 PC: AAC 실패 → Opus 실패 → WAV만 성공 ✅
- 코덱 폴백 체인: AAC → Opus → WAV (정상 작동)

**근본 원인**:
- Windows Media Feature Pack 미설치 또는 불완전
- AAC/Opus 코덱 DLL 미설치 또는 손상
- Windows Media Foundation API 호환성 문제

**영향**:
- ✅ 녹음 기능: 정상 작동 (WAV로 폴백)
- ⚠️ 파일 크기: WAV는 무압축이라 용량 큼
  - 10분 녹음: 약 19 MB (AAC/Opus 대비 약 4배)
  - 하루 8시간: 약 912 MB (약 0.9 GB)

### 2. 해결 방안: WAV → AAC/Opus 사후 변환

**접근 방식**:
- 녹음은 WAV로 진행 (안정성 보장)
- 녹음 완료 후 자동으로 AAC/Opus로 변환 (용량 절감)
- 변환 실패 시 원본 WAV 유지 (안전성 보장)

---

## ✅ 기술적 가능성 진단

### 가능함 - 다음 이유로 구현 가능

#### 1. 기존 구조 활용 가능
- `splitSegment()` 메서드에서 세그먼트 완료 시 콜백 존재
- 비동기 처리로 녹음 중단 없이 변환 가능
- 백그라운드 작업으로 사용자 경험 영향 최소화

#### 2. ffmpeg 도구 사용
- Windows에서 안정적으로 작동하는 오픈소스 도구
- Windows Media Foundation과 **완전히 독립적**
- 단일 실행 파일로 배포 가능 (추가 DLL 불필요)

#### 3. 진료실 PC 호환성
- ✅ **ffmpeg는 Windows Media Foundation과 무관**
  - 자체 코덱 라이브러리 사용
  - 녹음 코덱 문제와 완전히 별개
- ✅ Visual C++ Runtime은 이미 설치됨 (v1.2.8에서 해결)
- ✅ 추가 의존성 없이 단일 실행 파일로 동작

#### 4. 성능 영향 분석
- **변환 시간**: 10분 녹음 기준 1-3초
- **CPU 사용량**: 변환 중 20-30% 증가 (백그라운드 처리)
- **녹음 영향**: 없음 (5초 지연 + 큐 관리로 최소화)

---

## ⚠️ 주요 우려사항 및 해결 방안

### 1. 동시성 문제: 녹음 + 변환 동시 실행

**우려**:
- 세그먼트 분할 시 새 녹음 시작과 변환이 동시에 실행
- 진료실 PC는 오래된 하드웨어일 가능성
- CPU/디스크 I/O 경쟁으로 녹음 품질 저하 가능

**해결 방안** (2단계 방어):

**방안 A: 변환 지연 실행** ✅
- 새 녹음 시작 완료 후 **5초 대기** 후 변환 시작
- 녹음 안정화 시간 확보
- 디스크 I/O 경쟁 최소화

**방안 B: 변환 큐 시스템** ✅
- 동시 변환 개수 제한: **최대 1개**
- 진료실 PC 성능 고려
- 녹음 우선 보장

**구현 코드**:
```dart
// splitSegment() 메서드 내부
if (completedEncoder == AudioEncoder.wav && 
    _settingsService.isWavAutoConvertEnabled()) {
  // 새 녹음 안정화를 위해 5초 대기 후 변환 시작
  Future.delayed(const Duration(seconds: 5), () {
    unawaited(_audioConverterService.convertWavToEncoded(
      wavPath: completedPath!,
      targetEncoder: _settingsService.getWavTargetEncoder(),
      bitRate: _profile.bitRate,
      sampleRate: _profile.sampleRate,
      deleteOriginal: true,
    ));
  });
}
```

### 2. 진료실 PC 환경 호환성

**확인 사항**:
- ✅ ffmpeg는 Windows Media Foundation과 독립적
- ✅ Visual C++ Runtime 이미 설치됨
- ✅ 단일 실행 파일로 동작 가능

**필수 조건**:
- ffmpeg.exe 파일 배포 필요 (약 100MB)
- 앱 패키지에 포함 또는 설치 링크 제공

### 3. 성능 영향 평가

**예상 시나리오** (10분 녹음 기준):

| 작업 | CPU 사용량 | 디스크 I/O | 소요 시간 | 영향 |
|------|-----------|-----------|----------|------|
| 녹음 중지 | 낮음 | 읽기 (1MB) | ~10ms | - |
| 새 녹음 시작 | 낮음 | 쓰기 준비 | ~50ms | - |
| 변환 시작 (5초 후) | 중간 (20-30%) | 읽기+쓰기 (19MB) | 1-3초 | 백그라운드 |
| 녹음 진행 중 | 매우 낮음 | 쓰기 (연속) | 연속 | 변환 영향 없음 |

**결론**:
- ✅ 녹음 품질: 영향 없음 (별도 프로세스, 5초 지연)
- ⚠️ CPU 사용량: 변환 중 20-30% 증가 (백그라운드 처리)
- ✅ 전체 안정성: 문제 없음 (지연 + 큐 관리)

---

## 🎯 구현 계획 (3단계)

### Phase 1: 기본 변환 기능 (v1.3.0) - 1주

**목표**: WAV 파일 자동 변환 기본 기능 구현

**작업 내용**:
1. `AudioConverterService` 클래스 생성
   - ffmpeg 프로세스 실행 및 관리
   - 변환 큐 시스템 (동시 변환 최대 1개)
   - 에러 처리 및 로깅

2. `AudioService` 통합
   - `splitSegment()` 메서드에 변환 로직 추가
   - 5초 지연 실행 구현
   - 설정 연동

3. 설정 UI 추가
   - 고급 설정에 "WAV 자동 변환" 옵션 추가
   - 목표 코덱 선택 (AAC/Opus)
   - 비트레이트 설정

4. ffmpeg 배포 준비
   - ffmpeg.exe 패키지에 포함
   - 설치 검증 로직

**기대 효과**:
- WAV 파일 자동 압축 (75% 용량 절감)
- 사용자 개입 없이 작동
- 변환 실패 시 원본 보존

### Phase 2: UI 개선 및 오류 처리 (v1.3.1) - 3일

**목표**: 사용자 경험 개선 및 안정성 강화

**작업 내용**:
1. 변환 상태 표시
   - 대시보드 카드에 변환 진행 상황 표시
   - 변환 완료 시 스낵바 알림

2. 오류 처리 강화
   - ffmpeg 미설치 감지 및 안내 메시지
   - 변환 실패 시 상세 로그 기록
   - 재시도 로직 (최대 3회)

3. 수동 변환 기능
   - 설정 탭에 "WAV 파일 변환" 버튼 추가
   - 파일 선택 또는 전체 변환
   - 진행률 표시

**기대 효과**:
- 사용자가 변환 상태를 확인 가능
- 문제 발생 시 명확한 안내
- 수동 제어 가능

### Phase 3: 최적화 (v1.3.2) - 3일

**목표**: 성능 및 리소스 사용 최적화

**작업 내용**:
1. 변환 큐 고도화
   - 우선순위 큐 (최신 파일 우선)
   - 큐 상태 모니터링 및 UI 표시
   - 디스크 I/O 모니터링

2. 프로세스 우선순위 설정
   - 변환 프로세스를 "낮음"으로 설정
   - 녹음 프로세스 우선 보장

3. 변환 품질 설정
   - 비트레이트 조정 옵션
   - 샘플레이트 다운샘플링 옵션

**기대 효과**:
- CPU/디스크 리소스 효율적 사용
- 녹음 품질 보장
- 사용자 맞춤 설정 가능

---

## 📐 기술 스펙

### ffmpeg 명령어

**WAV → AAC (M4A)**:
```bash
ffmpeg.exe -i input.wav -c:a aac -b:a 64k -ar 44100 -y output.m4a
```

**WAV → Opus**:
```bash
ffmpeg.exe -i input.wav -c:a libopus -b:a 64k -ar 44100 -y output.opus
```

### 파일 크기 예상

**10분 녹음 기준** (모노, 16kHz):
- WAV: 약 **19 MB** (무압축)
- AAC 64kbps: 약 **4.8 MB** (약 75% 절감) ✅
- Opus 64kbps: 약 **4.5 MB** (약 76% 절감) ✅

**하루 8시간 녹음 기준**:
- WAV: 약 **912 MB** (약 0.9 GB)
- AAC 64kbps: 약 **230 MB** (약 77% 절감) ✅
- Opus 64kbps: 약 **216 MB** (약 76% 절감) ✅

---

## ✅ 최종 결론

### 구현 가능성: **가능함**

**이유**:
1. ✅ 기존 코드 구조 활용 가능
2. ✅ ffmpeg 도구 사용 가능 (Windows Media Foundation과 독립적)
3. ✅ 진료실 PC에서도 작동 가능 (추가 의존성 없음)
4. ✅ 성능 영향 최소화 (5초 지연 + 큐 관리)

### 주요 해결 방안

1. **동시성 문제**: 변환 지연 실행 (5초) + 변환 큐 시스템
2. **진료실 PC 호환성**: ffmpeg 독립성 확인 및 배포 방법 확정
3. **성능 최적화**: 프로세스 우선순위 낮추기, 큐 관리

### 예상 효과

- **파일 크기**: WAV 대비 75% 이상 절감
- **녹음 품질**: 영향 없음 (별도 프로세스, 지연 실행)
- **사용자 경험**: 자동 변환으로 개입 불필요
- **안정성**: 변환 실패 시 원본 보존

### 다음 단계

1. ✅ 계획 수립 완료
2. ⏳ Phase 1 구현 시작 (v1.3.0)
3. ⏳ 진료실 PC에서 실제 환경 테스트
4. ⏳ 사용자 피드백 수집 및 개선

---

## 📄 참고 문서

- 전체 계획서: `docs/wav-to-aac-conversion-plan.md`
- 개발 가이드: `docs/developing.md`
- 테스트 가이드: `docs/test-release-guide.md`

---

**작성자**: AI Assistant (Composer)  
**검토 필요**: 진료실 PC 실제 환경 테스트 후 성능 지표 확인

